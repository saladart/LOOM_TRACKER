{% extends "base.html" %}

{% block content %}
<h2>Project Assignments Timeline</h2>
<div id="timeline"></div>

<!-- Assignment Modal -->
<div class="modal fade" id="assignmentModal" tabindex="-1" aria-labelledby="assignmentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="assignmentForm">
        <div class="modal-header">
          <h5 class="modal-title" id="assignmentModalLabel">Create Assignment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="modal-project-id">
          <div class="mb-3">
            <label for="user-select" class="form-label">Select User</label>
            <select class="form-select" id="user-select" required>
              {% for user in users %}
              <option value="{{ user.id }}">{{ user.username }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="start-date" class="form-label">Start Date</label>
            <input type="date" class="form-control" id="start-date" required>
          </div>
          <div class="mb-3">
            <label for="end-date" class="form-label">End Date</label>
            <input type="date" class="form-control" id="end-date" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Create Assignment</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include Vis Timeline library -->
<script src="https://unpkg.com/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script>
<link href="https://unpkg.com/vis-timeline/styles/vis-timeline-graph2d.min.css" rel="stylesheet">

<script>
var assignments = {{ assignments | tojson }};
var projects = {{ projects | tojson }};
var users = {{ users | tojson }};

// Map users and projects for easy lookup
var userMap = {};
var userColors = {};
var colorPalette = ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6'];
users.forEach((user, index) => {
    userMap[user.id] = user.username;
    userColors[user.id] = colorPalette[index % colorPalette.length];
});

var projectMap = {};
projects.forEach(project => {
    projectMap[project.id] = project.name;
});

// Prepare items and groups for timeline
var items = new vis.DataSet(assignments.map(assign => ({
    id: assign.id,
    content: userMap[assign.user_id],
    start: assign.start_date,
    end: assign.end_date,
    group: assign.project_id,
    style: 'background-color:' + userColors[assign.user_id] + '; color: #fff;'
})));

var groups = new vis.DataSet(projects.map(project => ({
    id: project.id,
    content: project.name
})));

// Create timeline
var container = document.getElementById('timeline');
var options = {
    editable: {
        add: true,
        updateTime: true,
        remove: true,
        overrideItems: true
    },
    stack: true,
    orientation: 'both',
    manipulation: {
        deleteItem: function(item, callback) {
            if (confirm('Are you sure you want to delete this assignment?')) {
                fetch('{{ url_for("main.delete_assignment") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: item.id
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        callback(item); // Confirm deletion
                    } else {
                        alert('Error deleting assignment');
                        callback(null); // Cancel deletion
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting assignment');
                    callback(null); // Cancel deletion
                });
            } else {
                callback(null); // Cancel deletion if not confirmed
            }
        }
    }
};
var timeline = new vis.Timeline(container, items, groups, options);

// Handle adding new assignments
timeline.on('doubleClick', function (props) {
    if (props.group) {
        var projectId = props.group;
        var clickedDate = props.time;

        // Set default dates in the modal
        var dateStr = clickedDate.toISOString().split('T')[0];
        document.getElementById('modal-project-id').value = projectId;
        document.getElementById('start-date').value = dateStr;
        document.getElementById('end-date').value = dateStr;

        // Show the modal
        var assignmentModal = new bootstrap.Modal(document.getElementById('assignmentModal'));
        assignmentModal.show();
    }
});

// Handle form submission
document.getElementById('assignmentForm').addEventListener('submit', function (e) {
    e.preventDefault();
    var userId = document.getElementById('user-select').value;
    var projectId = document.getElementById('modal-project-id').value;
    var startDate = document.getElementById('start-date').value;
    var endDate = document.getElementById('end-date').value;

    // Create assignment via AJAX
    fetch('{{ url_for("main.create_assignment") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            user_id: userId,
            project_id: projectId,
            start_date: startDate,
            end_date: endDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Add new item to timeline
            items.add({
                id: data.assignment.id,
                content: userMap[data.assignment.user_id],
                start: data.assignment.start_date,
                end: data.assignment.end_date,
                group: data.assignment.project_id,
                style: 'background-color:' + userColors[data.assignment.user_id] + '; color: #fff;'
            });
            // Hide the modal
            var assignmentModal = bootstrap.Modal.getInstance(document.getElementById('assignmentModal'));
            assignmentModal.hide();
        } else {
            alert('Error creating assignment');
        }
    });
});

// Handle item updates
timeline.on('update', function (properties) {
    var item = properties.item;
    // Update assignment via AJAX
    fetch('{{ url_for("main.update_assignment") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id: item.id,
            start_date: item.start,
            end_date: item.end
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status !== 'success') {
            alert('Error updating assignment');
            properties.callback(null); // Cancel the change
        } else {
            properties.callback(item); // Confirm the change
        }
    });
});

// // Handle item removal
// timeline.on('remove', function (properties, callback) {  // Add callback parameter
//     var itemId = properties.items[0];  // items is an array of selected item IDs
    
//     if (confirm('Are you sure you want to delete this assignment?')) {
//         // Delete assignment via AJAX
//         fetch('{{ url_for("main.delete_assignment") }}', {
//             method: 'POST',
//             headers: {
//                 'Content-Type': 'application/json',
//             },
//             body: JSON.stringify({
//                 id: itemId
//             })
//         })
//         .then(response => {
//             if (!response.ok) {
//                 throw new Error('Network response was not ok');
//             }
//             return response.json();
//         })
//         .then(data => {
//             if (data.status === 'success') {
//                 callback(itemId);  // Confirm deletion with the itemId
//                 items.remove(itemId);  // Remove from the DataSet
//             } else {
//                 throw new Error(data.message || 'Error deleting assignment');
//             }
//         })
//         .catch(error => {
//             console.error('Error:', error);
//             alert('Error deleting assignment');
//             callback(null);  // Cancel deletion
//         });
//     } else {
//         callback(null);  // Cancel deletion if not confirmed
//     }
// });

</script>
{% endblock %}